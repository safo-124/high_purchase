generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                  String           @id @default(cuid())
  email               String           @unique
  name                String?
  passwordHash        String
  role                Role
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  auditLogs           AuditLog[]       @relation("AuditLogActor")
  businessMemberships BusinessMember[] @relation("UserBusinessMemberships")
  customerProfiles    Customer[]       @relation("CustomerUser")
  sentMessages        Message[]        @relation("MessageSender")
  memberships         ShopMember[]     @relation("UserMemberships")
}

model Business {
  id            String           @id @default(cuid())
  name          String
  businessSlug  String           @unique
  country       String           @default("Ghana")
  isActive      Boolean          @default(true)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  brands        Brand[]          @relation("BusinessBrands")
  members       BusinessMember[] @relation("BusinessMembers")
  policy        BusinessPolicy?  @relation("BusinessPolicy")
  categories    Category[]       @relation("BusinessCategories")
  emailSettings EmailSettings?   @relation("BusinessEmailSettings")
  products      Product[]        @relation("BusinessProducts")
  shops         Shop[]           @relation("BusinessShops")
  smsSettings   SmsSettings?     @relation("BusinessSmsSettings")
  taxes         Tax[]            @relation("BusinessTaxes")
}

model BusinessPolicy {
  id           String       @id @default(cuid())
  businessId   String       @unique
  interestType InterestType @default(FLAT)
  interestRate Decimal      @default(0.00) @db.Decimal(5, 2)
  graceDays    Int          @default(3)
  maxTenorDays Int          @default(60)
  lateFeeFixed Decimal?     @db.Decimal(10, 2)
  lateFeeRate  Decimal?     @db.Decimal(5, 2)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  business     Business     @relation("BusinessPolicy", fields: [businessId], references: [id], onDelete: Cascade)
}

// Tax configuration - optional taxes that can be assigned to products, categories, brands, or shops
model Tax {
  id          String        @id @default(cuid())
  businessId  String
  name        String        // e.g., "VAT", "Sales Tax", "Excise Duty"
  description String?
  rate        Decimal       @db.Decimal(5, 2) // Tax rate as percentage (e.g., 12.50 for 12.5%)
  isCompound  Boolean       @default(false) // If true, applies after other taxes
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  business    Business      @relation("BusinessTaxes", fields: [businessId], references: [id], onDelete: Cascade)
  // Many-to-many relationships for flexible assignment
  products    ProductTax[]
  categories  CategoryTax[]
  brands      BrandTax[]
  shops       ShopTax[]

  @@unique([businessId, name])
  @@index([businessId])
  @@index([isActive])
}

// Junction tables for tax assignments
model ProductTax {
  id        String   @id @default(cuid())
  productId String
  taxId     String
  createdAt DateTime @default(now())
  product   Product  @relation("ProductTaxes", fields: [productId], references: [id], onDelete: Cascade)
  tax       Tax      @relation(fields: [taxId], references: [id], onDelete: Cascade)

  @@unique([productId, taxId])
  @@index([productId])
  @@index([taxId])
}

model CategoryTax {
  id         String   @id @default(cuid())
  categoryId String
  taxId      String
  createdAt  DateTime @default(now())
  category   Category @relation("CategoryTaxes", fields: [categoryId], references: [id], onDelete: Cascade)
  tax        Tax      @relation(fields: [taxId], references: [id], onDelete: Cascade)

  @@unique([categoryId, taxId])
  @@index([categoryId])
  @@index([taxId])
}

model BrandTax {
  id        String   @id @default(cuid())
  brandId   String
  taxId     String
  createdAt DateTime @default(now())
  brand     Brand    @relation("BrandTaxes", fields: [brandId], references: [id], onDelete: Cascade)
  tax       Tax      @relation(fields: [taxId], references: [id], onDelete: Cascade)

  @@unique([brandId, taxId])
  @@index([brandId])
  @@index([taxId])
}

model ShopTax {
  id        String   @id @default(cuid())
  shopId    String
  taxId     String
  createdAt DateTime @default(now())
  shop      Shop     @relation("ShopTaxes", fields: [shopId], references: [id], onDelete: Cascade)
  tax       Tax      @relation(fields: [taxId], references: [id], onDelete: Cascade)

  @@unique([shopId, taxId])
  @@index([shopId])
  @@index([taxId])
}

model BusinessMember {
  id         String   @id @default(cuid())
  userId     String
  businessId String
  role       Role     @default(BUSINESS_ADMIN)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  business   Business @relation("BusinessMembers", fields: [businessId], references: [id], onDelete: Cascade)
  user       User     @relation("UserBusinessMemberships", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, businessId])
  @@index([userId])
  @@index([businessId])
}

model Shop {
  id           String        @id @default(cuid())
  businessId   String
  name         String
  shopSlug     String        @unique
  country      String        @default("Ghana")
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  customers    Customer[]    @relation("ShopCustomers")
  messages     Message[]     @relation("ShopMessages")
  business     Business      @relation("BusinessShops", fields: [businessId], references: [id], onDelete: Cascade)
  members      ShopMember[]  @relation("ShopMembers")
  policy       ShopPolicy?   @relation("ShopPolicy")
  shopProducts ShopProduct[] @relation("ShopProductInventory")
  taxes        ShopTax[]     @relation("ShopTaxes")

  @@index([businessId])
}

model Category {
  id          String        @id @default(cuid())
  businessId  String
  name        String
  description String?
  color       String?       @default("#6366f1")
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  business    Business      @relation("BusinessCategories", fields: [businessId], references: [id], onDelete: Cascade)
  products    Product[]     @relation("CategoryProducts")
  taxes       CategoryTax[] @relation("CategoryTaxes")

  @@unique([businessId, name])
  @@index([businessId])
  @@index([isActive])
}

model Brand {
  id          String     @id @default(cuid())
  businessId  String
  name        String
  description String?
  logoUrl     String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  business    Business   @relation("BusinessBrands", fields: [businessId], references: [id], onDelete: Cascade)
  products    Product[]  @relation("BrandProducts")
  taxes       BrandTax[] @relation("BrandTaxes")

  @@unique([businessId, name])
  @@index([businessId])
  @@index([isActive])
}

model Customer {
  id                  String            @id @default(cuid())
  shopId              String
  userId              String?
  firstName           String
  lastName            String
  phone               String
  email               String?
  idType              String?
  idNumber            String?
  address             String?
  city                String?
  region              String?
  preferredPayment    PaymentPreference @default(BOTH)
  assignedCollectorId String?
  emailNotifications  Boolean           @default(true)
  smsNotifications    Boolean           @default(true)
  notes               String?
  isActive            Boolean           @default(true)
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  assignedCollector   ShopMember?       @relation("AssignedCustomers", fields: [assignedCollectorId], references: [id])
  shop                Shop              @relation("ShopCustomers", fields: [shopId], references: [id], onDelete: Cascade)
  user                User?             @relation("CustomerUser", fields: [userId], references: [id])
  messages            Message[]         @relation("CustomerMessages")
  notifications       Notification[]    @relation("CustomerNotifications")
  purchases           Purchase[]        @relation("CustomerPurchases")

  @@unique([shopId, phone])
  @@index([shopId])
  @@index([userId])
  @@index([assignedCollectorId])
  @@index([isActive])
}

model Product {
  id                String         @id @default(cuid())
  businessId        String
  shopId            String?
  categoryId        String?
  brandId           String?
  name              String
  description       String?
  sku               String?
  costPrice         Decimal        @default(0) @db.Decimal(12, 2)
  cashPrice         Decimal        @default(0) @db.Decimal(12, 2)
  layawayPrice      Decimal        @default(0) @db.Decimal(12, 2)
  creditPrice       Decimal        @default(0) @db.Decimal(12, 2)
  price             Decimal        @db.Decimal(12, 2)
  stockQuantity     Int            @default(0)
  lowStockThreshold Int            @default(5)
  imageUrl          String?
  isActive          Boolean        @default(true)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  brand             Brand?         @relation("BrandProducts", fields: [brandId], references: [id])
  business          Business       @relation("BusinessProducts", fields: [businessId], references: [id], onDelete: Cascade)
  category          Category?      @relation("CategoryProducts", fields: [categoryId], references: [id])
  purchaseItems     PurchaseItem[] @relation("ProductPurchaseItems")
  shopProducts      ShopProduct[]  @relation("ProductShopInventory")
  taxes             ProductTax[]   @relation("ProductTaxes")

  @@unique([businessId, sku])
  @@index([businessId])
  @@index([shopId])
  @@index([categoryId])
  @@index([brandId])
  @@index([isActive])
}

model ShopProduct {
  id                String   @id @default(cuid())
  shopId            String
  productId         String
  stockQuantity     Int      @default(0)
  lowStockThreshold Int      @default(5)
  costPrice         Decimal? @db.Decimal(12, 2)
  cashPrice         Decimal? @db.Decimal(12, 2)
  layawayPrice      Decimal? @db.Decimal(12, 2)
  creditPrice       Decimal? @db.Decimal(12, 2)
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  product           Product  @relation("ProductShopInventory", fields: [productId], references: [id], onDelete: Cascade)
  shop              Shop     @relation("ShopProductInventory", fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, productId])
  @@index([shopId])
  @@index([productId])
  @@index([isActive])
}

model ShopMember {
  id                 String     @id @default(cuid())
  userId             String
  shopId             String
  role               Role       @default(SHOP_ADMIN)
  isActive           Boolean    @default(true)
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  assignedCustomers  Customer[] @relation("AssignedCustomers")
  collectedPayments  Payment[]  @relation("CollectorPayments")
  confirmedPayments  Payment[]  @relation("ConfirmedPayments")
  deliveredPurchases Purchase[] @relation("DeliveredPurchases")
  shop               Shop       @relation("ShopMembers", fields: [shopId], references: [id], onDelete: Cascade)
  user               User       @relation("UserMemberships", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, shopId])
  @@index([userId])
  @@index([shopId])
}

model ShopPolicy {
  id           String       @id @default(cuid())
  shopId       String       @unique
  interestType InterestType @default(FLAT)
  interestRate Decimal      @default(0.00) @db.Decimal(5, 2)
  graceDays    Int          @default(3)
  maxTenorDays Int          @default(60)
  lateFeeFixed Decimal?     @db.Decimal(10, 2)
  lateFeeRate  Decimal?     @db.Decimal(5, 2)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  shop         Shop         @relation("ShopPolicy", fields: [shopId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id          String   @id @default(cuid())
  actorUserId String?
  action      String
  entityType  String?
  entityId    String?
  metadata    Json?
  createdAt   DateTime @default(now())
  actor       User?    @relation("AuditLogActor", fields: [actorUserId], references: [id])
}

model Purchase {
  id                 String            @id @default(cuid())
  purchaseNumber     String
  customerId         String
  status             PurchaseStatus    @default(PENDING)
  purchaseType       PurchaseType      @default(CREDIT)
  subtotal           Decimal           @db.Decimal(12, 2)
  interestAmount     Decimal           @db.Decimal(12, 2)
  totalAmount        Decimal           @db.Decimal(12, 2)
  amountPaid         Decimal           @default(0) @db.Decimal(12, 2)
  outstandingBalance Decimal           @db.Decimal(12, 2)
  downPayment        Decimal           @default(0) @db.Decimal(12, 2)
  installments       Int               @default(1)
  startDate          DateTime          @default(now())
  dueDate            DateTime
  interestType       InterestType      @default(FLAT)
  interestRate       Decimal           @db.Decimal(5, 2)
  deliveryStatus     DeliveryStatus    @default(PENDING)
  deliveryAddress    String?
  deliveryNotes      String?
  scheduledDelivery  DateTime?
  deliveredAt        DateTime?
  deliveredById      String?
  notes              String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  payments           Payment[]         @relation("PurchasePayments")
  invoices           ProgressInvoice[] @relation("PurchaseInvoices")
  customer           Customer          @relation("CustomerPurchases", fields: [customerId], references: [id], onDelete: Cascade)
  deliveredBy        ShopMember?       @relation("DeliveredPurchases", fields: [deliveredById], references: [id])
  items              PurchaseItem[]    @relation("PurchaseItems")
  waybill            Waybill?          @relation("PurchaseWaybill")

  @@index([customerId])
  @@index([status])
  @@index([dueDate])
  @@index([deliveryStatus])
  @@index([purchaseType])
}

model PurchaseItem {
  id          String   @id @default(cuid())
  purchaseId  String
  productId   String?
  productName String
  quantity    Int      @default(1)
  unitPrice   Decimal  @db.Decimal(12, 2)
  totalPrice  Decimal  @db.Decimal(12, 2)
  createdAt   DateTime @default(now())
  product     Product? @relation("ProductPurchaseItems", fields: [productId], references: [id])
  purchase    Purchase @relation("PurchaseItems", fields: [purchaseId], references: [id], onDelete: Cascade)

  @@index([purchaseId])
  @@index([productId])
}

model Payment {
  id              String           @id @default(cuid())
  purchaseId      String
  amount          Decimal          @db.Decimal(12, 2)
  paymentMethod   PaymentMethod
  status          PaymentStatus    @default(COMPLETED)
  collectorId     String?
  isConfirmed     Boolean          @default(false)
  confirmedAt     DateTime?
  confirmedById   String?
  rejectedAt      DateTime?
  rejectionReason String?
  dueDate         DateTime?
  paidAt          DateTime?
  reference       String?
  notes           String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  collector       ShopMember?      @relation("CollectorPayments", fields: [collectorId], references: [id])
  confirmedBy     ShopMember?      @relation("ConfirmedPayments", fields: [confirmedById], references: [id])
  purchase        Purchase         @relation("PurchasePayments", fields: [purchaseId], references: [id], onDelete: Cascade)
  invoice         ProgressInvoice? @relation("PaymentInvoice")

  @@index([purchaseId])
  @@index([collectorId])
  @@index([status])
  @@index([dueDate])
  @@index([isConfirmed])
}

// Progress Invoice - Generated for each payment, visible to multiple roles
model ProgressInvoice {
  id                    String   @id @default(cuid())
  invoiceNumber         String   @unique
  paymentId             String   @unique
  purchaseId            String
  // Amount details at time of invoice
  paymentAmount         Decimal  @db.Decimal(12, 2)
  previousBalance       Decimal  @db.Decimal(12, 2)
  newBalance            Decimal  @db.Decimal(12, 2)
  totalPurchaseAmount   Decimal  @db.Decimal(12, 2)
  totalAmountPaid       Decimal  @db.Decimal(12, 2)
  // Who recorded/collected the payment
  collectorId           String?
  collectorName         String?
  // Who confirmed the payment (for collector payments)
  confirmedById         String?
  confirmedByName       String?
  // Payment method used
  paymentMethod         String
  // Customer info snapshot
  customerName          String
  customerPhone         String
  customerAddress       String?
  // Purchase info snapshot
  purchaseNumber        String
  purchaseType          String
  // Shop info snapshot
  shopId                String
  shopName              String
  businessId            String
  businessName          String
  // Status - whether purchase is now fully paid
  isPurchaseCompleted   Boolean  @default(false)
  // Waybill auto-generated when completed
  waybillGenerated      Boolean  @default(false)
  waybillNumber         String?
  // Metadata
  notes                 String?
  generatedAt           DateTime @default(now())
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  payment               Payment  @relation("PaymentInvoice", fields: [paymentId], references: [id], onDelete: Cascade)
  purchase              Purchase @relation("PurchaseInvoices", fields: [purchaseId], references: [id], onDelete: Cascade)

  @@index([purchaseId])
  @@index([shopId])
  @@index([businessId])
  @@index([collectorId])
  @@index([generatedAt])
  @@index([isPurchaseCompleted])
}

model Waybill {
  id                  String   @id @default(cuid())
  waybillNumber       String   @unique
  purchaseId          String   @unique
  recipientName       String
  recipientPhone      String
  deliveryAddress     String
  deliveryCity        String?
  deliveryRegion      String?
  specialInstructions String?
  generatedById       String?
  generatedAt         DateTime @default(now())
  receivedBy          String?
  signature           String?
  proofImageUrl       String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  purchase            Purchase @relation("PurchaseWaybill", fields: [purchaseId], references: [id], onDelete: Cascade)

  @@index([waybillNumber])
  @@index([purchaseId])
}

model Message {
  id           String        @id @default(cuid())
  shopId       String
  customerId   String
  senderId     String
  type         MessageType
  subject      String?
  body         String
  status       MessageStatus @default(PENDING)
  sentAt       DateTime?
  deliveredAt  DateTime?
  readAt       DateTime?
  errorMessage String?
  metadata     Json?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  customer     Customer      @relation("CustomerMessages", fields: [customerId], references: [id], onDelete: Cascade)
  sender       User          @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  shop         Shop          @relation("ShopMessages", fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([customerId])
  @@index([senderId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model Notification {
  id         String    @id @default(cuid())
  customerId String
  title      String
  body       String
  type       String
  link       String?
  isRead     Boolean   @default(false)
  readAt     DateTime?
  metadata   Json?
  createdAt  DateTime  @default(now())
  customer   Customer  @relation("CustomerNotifications", fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([isRead])
  @@index([createdAt])
}

model EmailSettings {
  id           String   @id @default(cuid())
  businessId   String   @unique
  fromEmail    String
  fromName     String
  replyToEmail String?
  smtpHost     String
  smtpPort     Int      @default(587)
  smtpUser     String
  smtpPassword String
  smtpSecure   Boolean  @default(false)
  isEnabled    Boolean  @default(true)
  isVerified   Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  business     Business @relation("BusinessEmailSettings", fields: [businessId], references: [id], onDelete: Cascade)
}

model EmailLog {
  id              String      @id @default(cuid())
  businessId      String
  shopId          String?
  subject         String
  body            String
  fromEmail       String
  fromName        String
  recipientEmails String[]
  recipientCount  Int
  status          EmailStatus @default(PENDING)
  sentAt          DateTime?
  errorMessage    String?
  sentByUserId    String?
  emailType       String?
  metadata        Json?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([businessId])
  @@index([shopId])
  @@index([status])
  @@index([createdAt])
  @@index([sentByUserId])
}

model SmsSettings {
  id              String      @id @default(cuid())
  businessId      String      @unique
  provider        SmsProvider @default(CUSTOM_API)
  senderId        String?
  apiEndpoint     String?
  apiKey          String?
  apiSecret       String?
  httpMethod      String      @default("POST")
  requestTemplate String?
  headersTemplate String?
  successField    String?
  successValue    String?
  isEnabled       Boolean     @default(true)
  isVerified      Boolean     @default(false)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  business        Business    @relation("BusinessSmsSettings", fields: [businessId], references: [id], onDelete: Cascade)
}

model SmsLog {
  id             String    @id @default(cuid())
  businessId     String
  shopId         String?
  recipientPhone String
  message        String
  senderId       String?
  status         SmsStatus @default(PENDING)
  sentAt         DateTime?
  deliveredAt    DateTime?
  errorMessage   String?
  providerRef    String?
  sentByUserId   String?
  smsType        String?
  metadata       Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([businessId])
  @@index([shopId])
  @@index([recipientPhone])
  @@index([status])
  @@index([createdAt])
  @@index([sentByUserId])
}

enum Role {
  SUPER_ADMIN
  BUSINESS_ADMIN
  SHOP_ADMIN
  SALES_STAFF
  DEBT_COLLECTOR
  CUSTOMER
}

enum InterestType {
  FLAT
  MONTHLY
}

enum PaymentPreference {
  ONLINE
  DEBT_COLLECTOR
  BOTH
}

enum PaymentMethod {
  CASH
  MOBILE_MONEY
  BANK_TRANSFER
  CARD
}

enum PurchaseType {
  CASH
  LAYAWAY
  CREDIT
}

enum PurchaseStatus {
  PENDING
  ACTIVE
  COMPLETED
  OVERDUE
  DEFAULTED
}

enum DeliveryStatus {
  PENDING
  SCHEDULED
  IN_TRANSIT
  DELIVERED
  FAILED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  PARTIAL
  MISSED
  WAIVED
}

enum MessageType {
  EMAIL
  SMS
  IN_APP
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  READ
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
  BOUNCED
}

enum SmsProvider {
  CUSTOM_API
  HUBTEL
  ARKESEL
  MNOTIFY
}

enum SmsStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
}
