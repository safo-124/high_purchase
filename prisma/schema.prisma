generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                      String           @id @default(cuid())
  email                   String           @unique
  name                    String?
  passwordHash            String
  plainPassword           String?          // Stored for super admin reference only
  role                    Role
  mustChangePassword      Boolean          @default(false) // Force password change on first login
  phone                   String?
  gender                  Gender?
  idCardType              IdCardType?
  idCardNumber            String?
  guarantorName           String?
  guarantorPhone          String?
  guarantorRelationship   String?
  address                 String?
  lastSeenAt              DateTime?        // Track last online activity
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt
  auditLogs               AuditLog[]       @relation("AuditLogActor")
  businessMemberships     BusinessMember[] @relation("UserBusinessMemberships")
  customerProfiles        Customer[]       @relation("CustomerUser")
  sentMessages            Message[]        @relation("MessageSender")
  memberships             ShopMember[]     @relation("UserMemberships")
  conversationsAsP1       Conversation[]   @relation("ConversationParticipant1")
  conversationsAsP2       Conversation[]   @relation("ConversationParticipant2")
  inAppMessages           InAppMessage[]   @relation("UserInAppMessages")
  posTransactions         PosTransaction[] @relation("UserPosTransactions")
}

model Business {
  id            String           @id @default(cuid())
  name          String
  businessSlug  String           @unique
  country       String           @default("Ghana")
  logoUrl       String?          // Business logo URL
  tagline       String?          // Business tagline/slogan
  address       String?          // Business address
  phone         String?          // Business phone number
  email         String?          // Business email
  website       String?          // Business website
  posEnabled    Boolean          @default(false) // POS system enabled by super admin
  supplyCatalogEnabled Boolean   @default(false) // Supply catalog enabled by super admin
  isActive      Boolean          @default(true)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  brands        Brand[]          @relation("BusinessBrands")
  members       BusinessMember[] @relation("BusinessMembers")
  policy        BusinessPolicy?  @relation("BusinessPolicy")
  categories    Category[]       @relation("BusinessCategories")
  emailSettings EmailSettings?   @relation("BusinessEmailSettings")
  products      Product[]        @relation("BusinessProducts")
  shops         Shop[]           @relation("BusinessShops")
  smsSettings   SmsSettings?     @relation("BusinessSmsSettings")
  taxes         Tax[]            @relation("BusinessTaxes")
  conversations Conversation[]   @relation("BusinessConversations")
  posTransactions PosTransaction[] @relation("BusinessPosTransactions")
  // Supply Catalog relations
  suppliers       Supplier[]       @relation("BusinessSuppliers")
  supplyCategories SupplyCategory[] @relation("BusinessSupplyCategories")
  supplyItems     SupplyItem[]     @relation("BusinessSupplyItems")
  // Bonus system relations
  bonusRules      BonusRule[]      @relation("BusinessBonusRules")
  bonusRecords    BonusRecord[]    @relation("BusinessBonusRecords")
  // Subscription relations
  subscription    Subscription?    @relation("BusinessSubscription")
}

model BusinessPolicy {
  id           String       @id @default(cuid())
  businessId   String       @unique
  interestType InterestType @default(FLAT)
  interestRate Decimal      @default(0.00) @db.Decimal(5, 2)
  graceDays    Int          @default(3)
  maxTenorDays Int          @default(60)
  lateFeeFixed Decimal?     @db.Decimal(10, 2)
  lateFeeRate  Decimal?     @db.Decimal(5, 2)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  business     Business     @relation("BusinessPolicy", fields: [businessId], references: [id], onDelete: Cascade)
}

// Tax configuration - optional taxes that can be assigned to products, categories, brands, or shops
model Tax {
  id          String        @id @default(cuid())
  businessId  String
  name        String        // e.g., "VAT", "Sales Tax", "Excise Duty"
  description String?
  rate        Decimal       @db.Decimal(5, 2) // Tax rate as percentage (e.g., 12.50 for 12.5%)
  isCompound  Boolean       @default(false) // If true, applies after other taxes
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  business    Business      @relation("BusinessTaxes", fields: [businessId], references: [id], onDelete: Cascade)
  // Many-to-many relationships for flexible assignment
  products    ProductTax[]
  categories  CategoryTax[]
  brands      BrandTax[]
  shops       ShopTax[]

  @@unique([businessId, name])
  @@index([businessId])
  @@index([isActive])
}

// Junction tables for tax assignments
model ProductTax {
  id        String   @id @default(cuid())
  productId String
  taxId     String
  createdAt DateTime @default(now())
  product   Product  @relation("ProductTaxes", fields: [productId], references: [id], onDelete: Cascade)
  tax       Tax      @relation(fields: [taxId], references: [id], onDelete: Cascade)

  @@unique([productId, taxId])
  @@index([productId])
  @@index([taxId])
}

model CategoryTax {
  id         String   @id @default(cuid())
  categoryId String
  taxId      String
  createdAt  DateTime @default(now())
  category   Category @relation("CategoryTaxes", fields: [categoryId], references: [id], onDelete: Cascade)
  tax        Tax      @relation(fields: [taxId], references: [id], onDelete: Cascade)

  @@unique([categoryId, taxId])
  @@index([categoryId])
  @@index([taxId])
}

model BrandTax {
  id        String   @id @default(cuid())
  brandId   String
  taxId     String
  createdAt DateTime @default(now())
  brand     Brand    @relation("BrandTaxes", fields: [brandId], references: [id], onDelete: Cascade)
  tax       Tax      @relation(fields: [taxId], references: [id], onDelete: Cascade)

  @@unique([brandId, taxId])
  @@index([brandId])
  @@index([taxId])
}

model ShopTax {
  id        String   @id @default(cuid())
  shopId    String
  taxId     String
  createdAt DateTime @default(now())
  shop      Shop     @relation("ShopTaxes", fields: [shopId], references: [id], onDelete: Cascade)
  tax       Tax      @relation(fields: [taxId], references: [id], onDelete: Cascade)

  @@unique([shopId, taxId])
  @@index([shopId])
  @@index([taxId])
}

model BusinessMember {
  id         String   @id @default(cuid())
  userId     String
  businessId String
  role       Role     @default(BUSINESS_ADMIN)
  isActive   Boolean  @default(true)
  // Accountant-specific permissions
  canConfirmPayments   Boolean  @default(false) // Allow accountant to confirm payments
  canExportData        Boolean  @default(true)  // Allow exporting financial data
  canViewProfitMargins Boolean  @default(true)  // Allow viewing cost prices and profit margins
  canRecordExpenses    Boolean  @default(false) // Allow recording business expenses
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  business   Business @relation("BusinessMembers", fields: [businessId], references: [id], onDelete: Cascade)
  user       User     @relation("UserBusinessMemberships", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, businessId])
  @@index([userId])
  @@index([businessId])
}

model Shop {
  id                  String            @id @default(cuid())
  businessId          String
  name                String
  shopSlug            String            @unique
  country             String            @default("Ghana")
  isActive            Boolean           @default(true)
  // Bank Payment Details
  bankName            String?
  bankAccountNumber   String?
  bankAccountName     String?
  bankBranch          String?
  // Mobile Money Details
  mobileMoneyProvider String?
  mobileMoneyNumber   String?
  mobileMoneyName     String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  customers           Customer[]        @relation("ShopCustomers")
  messages            Message[]         @relation("ShopMessages")
  business            Business          @relation("BusinessShops", fields: [businessId], references: [id], onDelete: Cascade)
  members             ShopMember[]      @relation("ShopMembers")
  policy              ShopPolicy?       @relation("ShopPolicy")
  shopProducts        ShopProduct[]     @relation("ShopProductInventory")
  taxes               ShopTax[]         @relation("ShopTaxes")
  purchaseInvoices    PurchaseInvoice[] @relation("ShopPurchaseInvoices")
  conversations       Conversation[]    @relation("ShopConversations")
  dailyReports        DailyReport[]     @relation("ShopDailyReports")
  walletTransactions  WalletTransaction[] @relation("ShopWalletTransactions")
  bonusRules           BonusRule[]          @relation("ShopBonusRules")

  @@index([businessId])
}

model Category {
  id          String        @id @default(cuid())
  businessId  String
  name        String
  description String?
  color       String?       @default("#6366f1")
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  business    Business      @relation("BusinessCategories", fields: [businessId], references: [id], onDelete: Cascade)
  products    Product[]     @relation("CategoryProducts")
  taxes       CategoryTax[] @relation("CategoryTaxes")

  @@unique([businessId, name])
  @@index([businessId])
  @@index([isActive])
}

model Brand {
  id          String     @id @default(cuid())
  businessId  String
  name        String
  description String?
  logoUrl     String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  business    Business   @relation("BusinessBrands", fields: [businessId], references: [id], onDelete: Cascade)
  products    Product[]  @relation("BrandProducts")
  taxes       BrandTax[] @relation("BrandTaxes")

  @@unique([businessId, name])
  @@index([businessId])
  @@index([isActive])
}

model Customer {
  id                  String            @id @default(cuid())
  shopId              String
  userId              String?
  firstName           String
  lastName            String
  phone               String
  email               String?
  idType              String?
  idNumber            String?
  address             String?
  city                String?
  region              String?
  preferredPayment    PaymentPreference @default(BOTH)
  assignedCollectorId String?
  emailNotifications  Boolean           @default(true)
  smsNotifications    Boolean           @default(true)
  notes               String?
  walletBalance       Decimal           @default(0) @db.Decimal(12, 2) // Customer wallet/savings balance
  isActive            Boolean           @default(true)
  lastSeenAt          DateTime?         // Track last online activity
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  assignedCollector   ShopMember?       @relation("AssignedCustomers", fields: [assignedCollectorId], references: [id])
  shop                Shop              @relation("ShopCustomers", fields: [shopId], references: [id], onDelete: Cascade)
  user                User?             @relation("CustomerUser", fields: [userId], references: [id])
  messages            Message[]         @relation("CustomerMessages")
  notifications       Notification[]    @relation("CustomerNotifications")
  purchases           Purchase[]        @relation("CustomerPurchases")
  conversations       Conversation[]    @relation("CustomerConversations")
  inAppMessages       InAppMessage[]    @relation("CustomerInAppMessages")
  walletTransactions  WalletTransaction[] @relation("CustomerWalletTransactions")

  @@unique([shopId, phone])
  @@index([shopId])
  @@index([userId])
  @@index([assignedCollectorId])
  @@index([isActive])
}

model Product {
  id                String         @id @default(cuid())
  businessId        String
  shopId            String?
  categoryId        String?
  brandId           String?
  name              String
  description       String?
  sku               String?
  costPrice         Decimal        @default(0) @db.Decimal(12, 2)
  cashPrice         Decimal        @default(0) @db.Decimal(12, 2)
  layawayPrice      Decimal        @default(0) @db.Decimal(12, 2)
  creditPrice       Decimal        @default(0) @db.Decimal(12, 2)
  price             Decimal        @db.Decimal(12, 2)
  stockQuantity     Int            @default(0)
  lowStockThreshold Int            @default(5)
  imageUrl          String?
  isActive          Boolean        @default(true)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  brand             Brand?         @relation("BrandProducts", fields: [brandId], references: [id])
  business          Business       @relation("BusinessProducts", fields: [businessId], references: [id], onDelete: Cascade)
  category          Category?      @relation("CategoryProducts", fields: [categoryId], references: [id])
  purchaseItems     PurchaseItem[] @relation("ProductPurchaseItems")
  shopProducts      ShopProduct[]  @relation("ProductShopInventory")
  taxes             ProductTax[]   @relation("ProductTaxes")

  @@unique([businessId, sku])
  @@index([businessId])
  @@index([shopId])
  @@index([categoryId])
  @@index([brandId])
  @@index([isActive])
}

model ShopProduct {
  id                String   @id @default(cuid())
  shopId            String
  productId         String
  stockQuantity     Int      @default(0)
  lowStockThreshold Int      @default(5)
  costPrice         Decimal? @db.Decimal(12, 2)
  cashPrice         Decimal? @db.Decimal(12, 2)
  layawayPrice      Decimal? @db.Decimal(12, 2)
  creditPrice       Decimal? @db.Decimal(12, 2)
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  product           Product  @relation("ProductShopInventory", fields: [productId], references: [id], onDelete: Cascade)
  shop              Shop     @relation("ShopProductInventory", fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, productId])
  @@index([shopId])
  @@index([productId])
  @@index([isActive])
}

model ShopMember {
  id                 String        @id @default(cuid())
  userId             String
  shopId             String
  role               Role          @default(SHOP_ADMIN)
  posAccess          Boolean       @default(false) // POS access granted by business admin
  canLoadWallet      Boolean       @default(false) // Permission to load customer wallets
  canSellProducts    Boolean       @default(false) // Permission for collectors to sell products
  canCreateCustomers Boolean       @default(false) // Permission for collectors to create customers
  isActive           Boolean       @default(true)
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  assignedCustomers  Customer[]    @relation("AssignedCustomers")
  collectedPayments  Payment[]     @relation("CollectorPayments")
  confirmedPayments  Payment[]     @relation("ConfirmedPayments")
  deliveredPurchases Purchase[]    @relation("DeliveredPurchases")
  dailyReports       DailyReport[] @relation("MemberDailyReports")
  shop               Shop          @relation("ShopMembers", fields: [shopId], references: [id], onDelete: Cascade)
  user               User          @relation("UserMemberships", fields: [userId], references: [id], onDelete: Cascade)
  createdWalletTransactions   WalletTransaction[] @relation("WalletTransactionCreator")
  confirmedWalletTransactions WalletTransaction[] @relation("WalletTransactionConfirmer")

  @@unique([userId, shopId])
  @@index([userId])
  @@index([shopId])
}

// Daily reports for sales staff and debt collectors
model DailyReport {
  id                 String            @id @default(cuid())
  shopMemberId       String
  shopId             String
  reportDate         DateTime          @db.Date
  reportType         DailyReportType
  status             DailyReportStatus @default(DRAFT)

  // Common fields
  notes              String?           @db.Text

  // Sales staff specific fields
  totalSalesAmount   Decimal?          @db.Decimal(10, 2)
  newCustomersCount  Int?
  newPurchasesCount  Int?
  itemsSoldCount     Int?

  // Debt collector specific fields
  customersVisited   Int?
  paymentsCollected  Int?
  totalCollected     Decimal?          @db.Decimal(10, 2)

  // Review fields
  reviewedById       String?
  reviewedAt         DateTime?
  reviewNotes        String?           @db.Text

  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  shopMember         ShopMember        @relation("MemberDailyReports", fields: [shopMemberId], references: [id], onDelete: Cascade)
  shop               Shop              @relation("ShopDailyReports", fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopMemberId, reportDate, reportType])
  @@index([shopId])
  @@index([reportDate])
  @@index([status])
}

model ShopPolicy {
  id           String       @id @default(cuid())
  shopId       String       @unique
  interestType InterestType @default(FLAT)
  interestRate Decimal      @default(0.00) @db.Decimal(5, 2)
  graceDays    Int          @default(3)
  maxTenorDays Int          @default(60)
  lateFeeFixed Decimal?     @db.Decimal(10, 2)
  lateFeeRate  Decimal?     @db.Decimal(5, 2)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  shop         Shop         @relation("ShopPolicy", fields: [shopId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id          String   @id @default(cuid())
  actorUserId String?
  action      String
  entityType  String?
  entityId    String?
  metadata    Json?
  createdAt   DateTime @default(now())
  actor       User?    @relation("AuditLogActor", fields: [actorUserId], references: [id])
}

model Purchase {
  id                 String            @id @default(cuid())
  purchaseNumber     String
  customerId         String
  status             PurchaseStatus    @default(PENDING)
  purchaseType       PurchaseType      @default(CREDIT)
  subtotal           Decimal           @db.Decimal(12, 2)
  interestAmount     Decimal           @db.Decimal(12, 2)
  totalAmount        Decimal           @db.Decimal(12, 2)
  amountPaid         Decimal           @default(0) @db.Decimal(12, 2)
  outstandingBalance Decimal           @db.Decimal(12, 2)
  downPayment        Decimal           @default(0) @db.Decimal(12, 2)
  installments       Int               @default(1)
  startDate          DateTime          @default(now())
  dueDate            DateTime
  interestType       InterestType      @default(FLAT)
  interestRate       Decimal           @db.Decimal(5, 2)
  deliveryStatus     DeliveryStatus    @default(PENDING)
  deliveryAddress    String?
  deliveryNotes      String?
  scheduledDelivery  DateTime?
  deliveredAt        DateTime?
  deliveredById      String?
  notes              String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  payments           Payment[]         @relation("PurchasePayments")
  invoices           ProgressInvoice[] @relation("PurchaseInvoices")
  purchaseInvoice    PurchaseInvoice?  @relation("PurchaseInvoiceRecord")
  customer           Customer          @relation("CustomerPurchases", fields: [customerId], references: [id], onDelete: Cascade)
  deliveredBy        ShopMember?       @relation("DeliveredPurchases", fields: [deliveredById], references: [id])
  items              PurchaseItem[]    @relation("PurchaseItems")
  waybill            Waybill?          @relation("PurchaseWaybill")

  @@index([customerId])
  @@index([status])
  @@index([dueDate])
  @@index([deliveryStatus])
  @@index([purchaseType])
}

model PurchaseItem {
  id          String   @id @default(cuid())
  purchaseId  String
  productId   String?
  productName String
  quantity    Int      @default(1)
  unitPrice   Decimal  @db.Decimal(12, 2)
  totalPrice  Decimal  @db.Decimal(12, 2)
  createdAt   DateTime @default(now())
  product     Product? @relation("ProductPurchaseItems", fields: [productId], references: [id])
  purchase    Purchase @relation("PurchaseItems", fields: [purchaseId], references: [id], onDelete: Cascade)

  @@index([purchaseId])
  @@index([productId])
}

model Payment {
  id              String           @id @default(cuid())
  purchaseId      String
  amount          Decimal          @db.Decimal(12, 2)
  paymentMethod   PaymentMethod
  status          PaymentStatus    @default(COMPLETED)
  collectorId     String?
  isConfirmed     Boolean          @default(false)
  confirmedAt     DateTime?
  confirmedById   String?
  rejectedAt      DateTime?
  rejectionReason String?
  dueDate         DateTime?
  paidAt          DateTime?
  reference       String?
  notes           String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  collector       ShopMember?      @relation("CollectorPayments", fields: [collectorId], references: [id])
  confirmedBy     ShopMember?      @relation("ConfirmedPayments", fields: [confirmedById], references: [id])
  purchase        Purchase         @relation("PurchasePayments", fields: [purchaseId], references: [id], onDelete: Cascade)
  invoice         ProgressInvoice? @relation("PaymentInvoice")

  @@index([purchaseId])
  @@index([collectorId])
  @@index([status])
  @@index([dueDate])
  @@index([isConfirmed])
}

// Progress Invoice - Generated for each payment, visible to multiple roles
model ProgressInvoice {
  id                    String   @id @default(cuid())
  invoiceNumber         String   @unique
  paymentId             String   @unique
  purchaseId            String
  // Amount details at time of invoice
  paymentAmount         Decimal  @db.Decimal(12, 2)
  previousBalance       Decimal  @db.Decimal(12, 2)
  newBalance            Decimal  @db.Decimal(12, 2)
  totalPurchaseAmount   Decimal  @db.Decimal(12, 2)
  totalAmountPaid       Decimal  @db.Decimal(12, 2)
  // Who recorded/collected the payment
  collectorId           String?
  collectorName         String?
  // Who confirmed the payment (for collector payments)
  confirmedById         String?
  confirmedByName       String?
  // Who actually recorded the payment (role info)
  recordedByRole        String?  // "COLLECTOR", "SHOP_ADMIN", "BUSINESS_ADMIN"
  recordedByName        String?
  // Shop admin info
  shopAdminName         String?
  // Payment method used
  paymentMethod         String
  // Customer info snapshot
  customerName          String
  customerPhone         String
  customerAddress       String?
  // Purchase info snapshot
  purchaseNumber        String
  purchaseType          String
  // Shop info snapshot
  shopId                String
  shopName              String
  businessId            String
  businessName          String
  // Status - whether purchase is now fully paid
  isPurchaseCompleted   Boolean  @default(false)
  // Waybill auto-generated when completed
  waybillGenerated      Boolean  @default(false)
  waybillNumber         String?
  // Metadata
  notes                 String?
  generatedAt           DateTime @default(now())
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  payment               Payment  @relation("PaymentInvoice", fields: [paymentId], references: [id], onDelete: Cascade)
  purchase              Purchase @relation("PurchaseInvoices", fields: [purchaseId], references: [id], onDelete: Cascade)

  @@index([purchaseId])
  @@index([shopId])
  @@index([businessId])
  @@index([collectorId])
  @@index([generatedAt])
  @@index([isPurchaseCompleted])
}

// Purchase Invoice - Generated at time of purchase (before payment)
// Shows what customer needs to pay, payment methods available, collector assigned
model PurchaseInvoice {
  id                  String   @id @default(cuid())
  invoiceNumber       String   @unique
  purchaseId          String   @unique
  // Purchase details
  purchaseNumber      String
  purchaseType        String
  subtotal            Decimal  @db.Decimal(12, 2)
  interestAmount      Decimal  @db.Decimal(12, 2)
  totalAmount         Decimal  @db.Decimal(12, 2)
  downPayment         Decimal  @db.Decimal(12, 2)
  installments        Int      @default(1)
  dueDate             DateTime
  // Customer info
  customerId          String
  customerName        String
  customerPhone       String
  customerAddress     String?
  // Assigned collector info
  collectorId         String?
  collectorName       String?
  collectorPhone      String?
  // Shop info
  shopId              String
  shopName            String
  shopAdminName       String?
  // Business info
  businessId          String
  businessName        String
  // Payment method options available
  paymentMethods      String[] // ["CASH", "MOBILE_MONEY", "BANK_TRANSFER"]
  // Bank details (if bank payment is available)
  bankName            String?
  bankAccountNumber   String?
  bankAccountName     String?
  bankBranch          String?
  // Mobile money details (if mobile money is available)
  mobileMoneyProvider String?
  mobileMoneyNumber   String?
  mobileMoneyName     String?
  // Items snapshot
  itemsSnapshot       Json     // Array of purchase items
  // Status
  status              String   @default("PENDING") // PENDING, PARTIALLY_PAID, FULLY_PAID
  // Metadata
  notes               String?
  generatedAt         DateTime @default(now())
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  // Relations
  purchase            Purchase @relation("PurchaseInvoiceRecord", fields: [purchaseId], references: [id], onDelete: Cascade)
  shop                Shop     @relation("ShopPurchaseInvoices", fields: [shopId], references: [id], onDelete: Cascade)

  @@index([purchaseId])
  @@index([customerId])
  @@index([shopId])
  @@index([businessId])
  @@index([status])
  @@index([generatedAt])
}

model Waybill {
  id                  String   @id @default(cuid())
  waybillNumber       String   @unique
  purchaseId          String   @unique
  recipientName       String
  recipientPhone      String
  deliveryAddress     String
  deliveryCity        String?
  deliveryRegion      String?
  specialInstructions String?
  generatedById       String?
  generatedAt         DateTime @default(now())
  receivedBy          String?
  signature           String?
  proofImageUrl       String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  purchase            Purchase @relation("PurchaseWaybill", fields: [purchaseId], references: [id], onDelete: Cascade)

  @@index([waybillNumber])
  @@index([purchaseId])
}

// Legacy Message model for SMS/Email notifications to customers
model Message {
  id           String        @id @default(cuid())
  shopId       String
  customerId   String
  senderId     String
  type         MessageType
  subject      String?
  body         String
  status       MessageStatus @default(PENDING)
  sentAt       DateTime?
  deliveredAt  DateTime?
  readAt       DateTime?
  errorMessage String?
  metadata     Json?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  customer     Customer      @relation("CustomerMessages", fields: [customerId], references: [id], onDelete: Cascade)
  sender       User          @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  shop         Shop          @relation("ShopMessages", fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([customerId])
  @@index([senderId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

// In-App Messaging System - Conversations between users
model Conversation {
  id                     String             @id @default(cuid())
  businessId             String
  shopId                 String?            // Null for business-level conversations
  // Participant 1 (can be a User/Staff)
  participant1Id         String?
  // Participant 2 (can be a User/Staff)  
  participant2Id         String?
  // Customer participant (when conversation involves a customer)
  customerId             String?
  // Conversation type for permission filtering
  conversationType       ConversationType
  lastMessageAt          DateTime?
  lastMessagePreview     String?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  business               Business           @relation("BusinessConversations", fields: [businessId], references: [id], onDelete: Cascade)
  shop                   Shop?              @relation("ShopConversations", fields: [shopId], references: [id], onDelete: Cascade)
  participant1           User?              @relation("ConversationParticipant1", fields: [participant1Id], references: [id], onDelete: Cascade)
  participant2           User?              @relation("ConversationParticipant2", fields: [participant2Id], references: [id], onDelete: Cascade)
  customer               Customer?          @relation("CustomerConversations", fields: [customerId], references: [id], onDelete: Cascade)
  messages               InAppMessage[]     @relation("ConversationMessages")

  @@unique([businessId, participant1Id, participant2Id])
  @@unique([businessId, participant1Id, customerId])
  @@index([businessId])
  @@index([shopId])
  @@index([participant1Id])
  @@index([participant2Id])
  @@index([customerId])
  @@index([lastMessageAt])
}

// Individual messages within a conversation
model InAppMessage {
  id               String       @id @default(cuid())
  conversationId   String
  // Sender can be a User/Staff
  senderId         String?
  // Or sender can be a Customer
  senderCustomerId String?
  content          String
  isRead           Boolean      @default(false)
  readAt           DateTime?
  // System message flag - cannot be edited/deleted
  isSystemMessage  Boolean      @default(false)
  // Editing support
  isEdited         Boolean      @default(false)
  editedAt         DateTime?
  // Soft delete support
  isDeleted        Boolean      @default(false)
  deletedAt        DateTime?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  conversation     Conversation @relation("ConversationMessages", fields: [conversationId], references: [id], onDelete: Cascade)
  sender           User?        @relation("UserInAppMessages", fields: [senderId], references: [id], onDelete: Cascade)
  senderCustomer   Customer?    @relation("CustomerInAppMessages", fields: [senderCustomerId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([senderCustomerId])
  @@index([createdAt])
  @@index([isRead])
  @@index([isDeleted])
}

model Notification {
  id         String    @id @default(cuid())
  customerId String
  title      String
  body       String
  type       String
  link       String?
  isRead     Boolean   @default(false)
  readAt     DateTime?
  metadata   Json?
  createdAt  DateTime  @default(now())
  customer   Customer  @relation("CustomerNotifications", fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([isRead])
  @@index([createdAt])
}

model EmailSettings {
  id           String   @id @default(cuid())
  businessId   String   @unique
  fromEmail    String
  fromName     String
  replyToEmail String?
  smtpHost     String
  smtpPort     Int      @default(587)
  smtpUser     String
  smtpPassword String
  smtpSecure   Boolean  @default(false)
  isEnabled    Boolean  @default(true)
  isVerified   Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  business     Business @relation("BusinessEmailSettings", fields: [businessId], references: [id], onDelete: Cascade)
}

model EmailLog {
  id              String      @id @default(cuid())
  businessId      String
  shopId          String?
  subject         String
  body            String
  fromEmail       String
  fromName        String
  recipientEmails String[]
  recipientCount  Int
  status          EmailStatus @default(PENDING)
  sentAt          DateTime?
  errorMessage    String?
  sentByUserId    String?
  emailType       String?
  metadata        Json?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([businessId])
  @@index([shopId])
  @@index([status])
  @@index([createdAt])
  @@index([sentByUserId])
}

model SmsSettings {
  id              String      @id @default(cuid())
  businessId      String      @unique
  provider        SmsProvider @default(CUSTOM_API)
  senderId        String?
  apiEndpoint     String?
  apiKey          String?
  apiSecret       String?
  httpMethod      String      @default("POST")
  requestTemplate String?
  headersTemplate String?
  successField    String?
  successValue    String?
  isEnabled       Boolean     @default(true)
  isVerified      Boolean     @default(false)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  business        Business    @relation("BusinessSmsSettings", fields: [businessId], references: [id], onDelete: Cascade)
}

model SmsLog {
  id             String    @id @default(cuid())
  businessId     String
  shopId         String?
  recipientPhone String
  message        String
  senderId       String?
  status         SmsStatus @default(PENDING)
  sentAt         DateTime?
  deliveredAt    DateTime?
  errorMessage   String?
  providerRef    String?
  sentByUserId   String?
  smsType        String?
  metadata       Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([businessId])
  @@index([shopId])
  @@index([recipientPhone])
  @@index([status])
  @@index([createdAt])
  @@index([sentByUserId])
}

enum Role {
  SUPER_ADMIN
  BUSINESS_ADMIN
  ACCOUNTANT
  SHOP_ADMIN
  SALES_STAFF
  DEBT_COLLECTOR
  CUSTOMER
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum IdCardType {
  GHANA_CARD
  VOTER_ID
  PASSPORT
  DRIVERS_LICENSE
  OTHER
}

enum InterestType {
  FLAT
  MONTHLY
}

enum PaymentPreference {
  ONLINE
  DEBT_COLLECTOR
  BOTH
}

enum PaymentMethod {
  CASH
  MOBILE_MONEY
  BANK_TRANSFER
  CARD
  WALLET
}

enum PurchaseType {
  CASH
  LAYAWAY
  CREDIT
}

enum PurchaseStatus {
  PENDING
  ACTIVE
  COMPLETED
  OVERDUE
  DEFAULTED
}

enum DeliveryStatus {
  PENDING
  SCHEDULED
  IN_TRANSIT
  DELIVERED
  FAILED
}

enum DailyReportType {
  SALES
  COLLECTION
}

enum DailyReportStatus {
  DRAFT
  SUBMITTED
  REVIEWED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  PARTIAL
  MISSED
  WAIVED
}

enum MessageType {
  EMAIL
  SMS
  IN_APP
}

enum ConversationType {
  STAFF_TO_STAFF         // Between any two staff members
  STAFF_TO_CUSTOMER      // Between a staff member and a customer
  BUSINESS_BROADCAST     // Business admin to all
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  READ
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
  BOUNCED
}

enum SmsProvider {
  CUSTOM_API
  HUBTEL
  ARKESEL
  MNOTIFY
}

enum SmsStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
}

// POS Transaction model for Point of Sale system
model PosTransaction {
  id              String         @id @default(cuid())
  businessId      String
  shopId          String?        // Optional - if transaction is tied to a specific shop
  transactionNo   String         @unique
  cashierId       String         // User who processed the sale (business admin or shop staff)
  customerName    String?        // Walk-in customer name (optional)
  customerPhone   String?        // Walk-in customer phone (optional)
  subtotal        Decimal        @db.Decimal(12, 2)
  taxAmount       Decimal        @default(0) @db.Decimal(12, 2)
  discountAmount  Decimal        @default(0) @db.Decimal(12, 2)
  totalAmount     Decimal        @db.Decimal(12, 2)
  amountPaid      Decimal        @db.Decimal(12, 2)
  changeGiven     Decimal        @default(0) @db.Decimal(12, 2)
  paymentMethod   PaymentMethod  @default(CASH)
  status          PosStatus      @default(COMPLETED)
  voidReason      String?        // Reason for voiding the transaction
  notes           String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  business        Business       @relation("BusinessPosTransactions", fields: [businessId], references: [id], onDelete: Cascade)
  cashier         User           @relation("UserPosTransactions", fields: [cashierId], references: [id])
  items           PosTransactionItem[] @relation("PosTransactionItems")

  @@index([businessId])
  @@index([shopId])
  @@index([cashierId])
  @@index([createdAt])
  @@index([status])
}

model PosTransactionItem {
  id              String         @id @default(cuid())
  transactionId   String
  productId       String?        // Optional - can be a custom item
  productName     String
  quantity        Int
  unitPrice       Decimal        @db.Decimal(12, 2)
  totalPrice      Decimal        @db.Decimal(12, 2)
  createdAt       DateTime       @default(now())
  transaction     PosTransaction @relation("PosTransactionItems", fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([transactionId])
  @@index([productId])
}

enum PosStatus {
  COMPLETED
  VOIDED
  REFUNDED
}

// ==========================================
// SUPPLY CATALOG MODELS
// ==========================================

// Supplier - businesses/individuals that supply items
model Supplier {
  id              String       @id @default(cuid())
  businessId      String
  name            String
  contactPerson   String?
  email           String?
  phone           String?
  address         String?
  city            String?
  country         String?      @default("Ghana")
  website         String?
  notes           String?
  paymentTerms    String?      // e.g., "Net 30", "COD"
  bankName        String?
  bankAccountNumber String?
  bankAccountName String?
  momoProvider    String?
  momoNumber      String?
  momoName        String?
  rating          Int?         @default(0) // 0-5 rating
  isActive        Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  business        Business     @relation("BusinessSuppliers", fields: [businessId], references: [id], onDelete: Cascade)
  supplyItems     SupplyItem[] @relation("SupplierItems")

  @@unique([businessId, name])
  @@index([businessId])
  @@index([isActive])
}

// Supply Category - categorize supply items
model SupplyCategory {
  id          String       @id @default(cuid())
  businessId  String
  name        String
  description String?
  color       String?      @default("#8b5cf6") // Purple default
  imageUrl    String?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  business    Business     @relation("BusinessSupplyCategories", fields: [businessId], references: [id], onDelete: Cascade)
  supplyItems SupplyItem[] @relation("CategorySupplyItems")

  @@unique([businessId, name])
  @@index([businessId])
  @@index([isActive])
}

// Supply Item - items in the supply catalog
model SupplyItem {
  id              String         @id @default(cuid())
  businessId      String
  categoryId      String?
  supplierId      String?
  name            String
  description     String?
  sku             String?        // Stock Keeping Unit
  barcode         String?
  unit            String?        @default("pcs") // pcs, kg, liters, boxes, etc.
  unitPrice       Decimal        @db.Decimal(12, 2)
  minimumOrder    Int            @default(1)
  stockQuantity   Int            @default(0)
  reorderLevel    Int            @default(10) // Minimum stock before reorder
  reorderQuantity Int            @default(50) // How many to reorder
  imageUrl        String?
  leadTimeDays    Int?           @default(3) // Days to receive after ordering
  specifications  String?        // Technical specifications
  notes           String?
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  business        Business       @relation("BusinessSupplyItems", fields: [businessId], references: [id], onDelete: Cascade)
  category        SupplyCategory? @relation("CategorySupplyItems", fields: [categoryId], references: [id])
  supplier        Supplier?      @relation("SupplierItems", fields: [supplierId], references: [id])

  @@unique([businessId, sku])
  @@index([businessId])
  @@index([categoryId])
  @@index([supplierId])
  @@index([isActive])
}

// ========== CUSTOMER WALLET/SAVINGS SYSTEM ==========

// Wallet Transaction - tracks all wallet deposits, withdrawals, and adjustments
model WalletTransaction {
  id              String                    @id @default(cuid())
  customerId      String
  shopId          String                    // Shop where transaction originated
  type            WalletTransactionType
  amount          Decimal                   @db.Decimal(12, 2)
  balanceBefore   Decimal                   @db.Decimal(12, 2)
  balanceAfter    Decimal                   @db.Decimal(12, 2)
  description     String?
  reference       String?                   // Payment reference (e.g., mobile money reference)
  paymentMethod   PaymentMethod?
  status          WalletTransactionStatus   @default(PENDING)
  createdById     String?                   // Staff/person who created the transaction (null for admin/system)
  confirmedById   String?                   // Staff who confirmed (shop admin or business admin)
  confirmedAt     DateTime?
  rejectedReason  String?                   // Reason if rejected
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt
  
  customer        Customer                  @relation("CustomerWalletTransactions", fields: [customerId], references: [id], onDelete: Cascade)
  shop            Shop                      @relation("ShopWalletTransactions", fields: [shopId], references: [id], onDelete: Cascade)
  createdBy       ShopMember?               @relation("WalletTransactionCreator", fields: [createdById], references: [id])
  confirmedBy     ShopMember?               @relation("WalletTransactionConfirmer", fields: [confirmedById], references: [id])

  @@index([customerId])
  @@index([shopId])
  @@index([status])
  @@index([createdAt])
  @@index([createdById])
}

enum WalletTransactionType {
  DEPOSIT       // Customer loading money into wallet
  PURCHASE      // Using wallet balance for purchase
  ADJUSTMENT    // Admin adjustment (add/remove)
  REFUND        // Refund to wallet
}

enum WalletTransactionStatus {
  PENDING       // Awaiting confirmation
  CONFIRMED     // Confirmed and reflected in balance
  REJECTED      // Rejected by admin
}

// ========== ACCOUNTANT PORTAL MODELS ==========

// Expense - Track business expenses
model Expense {
  id              String          @id @default(cuid())
  businessId      String
  shopId          String?         // Optional - expense can be business-wide or shop-specific
  category        ExpenseCategory
  customCategory  String?         // If category is OTHER
  description     String
  amount          Decimal         @db.Decimal(12, 2)
  vendor          String?         // Who was paid
  reference       String?         // Receipt/invoice reference
  receiptUrl      String?         // Uploaded receipt image
  expenseDate     DateTime        @db.Date
  paymentMethod   PaymentMethod?
  isRecurring     Boolean         @default(false)
  recurringPeriod String?         // monthly, weekly, annually
  status          ExpenseStatus   @default(PENDING)
  approvedById    String?         // BusinessMember who approved
  approvedAt      DateTime?
  rejectedReason  String?
  notes           String?
  createdById     String          // BusinessMember who created
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([businessId])
  @@index([shopId])
  @@index([category])
  @@index([expenseDate])
  @@index([status])
}

// Budget - Track budget allocations and compare to actual spending
model Budget {
  id              String        @id @default(cuid())
  businessId      String
  shopId          String?       // Optional - budget can be business-wide or shop-specific
  name            String
  category        ExpenseCategory?
  customCategory  String?
  amount          Decimal       @db.Decimal(12, 2)
  period          BudgetPeriod
  startDate       DateTime      @db.Date
  endDate         DateTime      @db.Date
  notes           String?
  isActive        Boolean       @default(true)
  createdById     String
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([businessId])
  @@index([shopId])
  @@index([period])
  @@index([startDate])
  @@index([endDate])
}

// PaymentDispute - Handle payment discrepancies
model PaymentDispute {
  id              String            @id @default(cuid())
  businessId      String
  paymentId       String
  disputeType     DisputeType
  description     String            @db.Text
  disputedAmount  Decimal           @db.Decimal(12, 2)
  expectedAmount  Decimal?          @db.Decimal(12, 2)
  evidence        String?           // URL to uploaded evidence
  status          DisputeStatus     @default(OPEN)
  resolution      String?           @db.Text
  resolvedAmount  Decimal?          @db.Decimal(12, 2)
  raisedById      String            // AccountantMember who raised dispute
  assignedToId    String?           // Who is handling the dispute
  resolvedById    String?           // Who resolved the dispute
  resolvedAt      DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([businessId])
  @@index([paymentId])
  @@index([status])
  @@index([createdAt])
}

// Refund - Track refunds to customers
model Refund {
  id              String          @id @default(cuid())
  businessId      String
  purchaseId      String
  customerId      String
  reason          RefundReason
  customReason    String?
  amount          Decimal         @db.Decimal(12, 2)
  refundMethod    PaymentMethod
  status          RefundStatus    @default(PENDING)
  reference       String?         // Transaction reference
  processedAt     DateTime?
  approvedById    String?
  approvedAt      DateTime?
  rejectedReason  String?
  notes           String?
  requestedById   String          // Who requested the refund
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([businessId])
  @@index([purchaseId])
  @@index([customerId])
  @@index([status])
  @@index([createdAt])
}

// AccountantNote - Notes attached to transactions/payments
model AccountantNote {
  id              String          @id @default(cuid())
  businessId      String
  entityType      NoteEntityType  // Payment, Purchase, Customer, etc.
  entityId        String
  content         String          @db.Text
  isInternal      Boolean         @default(true) // Internal only or visible to others
  isPinned        Boolean         @default(false)
  createdById     String          // BusinessMember who created
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([businessId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

// DailyCashSummary - End of day cash reports
model DailyCashSummary {
  id                  String                  @id @default(cuid())
  businessId          String
  shopId              String
  summaryDate         DateTime                @db.Date
  // Opening balance
  openingCash         Decimal                 @db.Decimal(12, 2)
  openingMomo         Decimal                 @default(0) @db.Decimal(12, 2)
  openingBank         Decimal                 @default(0) @db.Decimal(12, 2)
  // Sales/Collections
  cashCollected       Decimal                 @default(0) @db.Decimal(12, 2)
  momoCollected       Decimal                 @default(0) @db.Decimal(12, 2)
  bankCollected       Decimal                 @default(0) @db.Decimal(12, 2)
  // Expenses paid out
  cashExpenses        Decimal                 @default(0) @db.Decimal(12, 2)
  momoExpenses        Decimal                 @default(0) @db.Decimal(12, 2)
  bankExpenses        Decimal                 @default(0) @db.Decimal(12, 2)
  // Closing balance (calculated)
  closingCash         Decimal                 @db.Decimal(12, 2)
  closingMomo         Decimal                 @default(0) @db.Decimal(12, 2)
  closingBank         Decimal                 @default(0) @db.Decimal(12, 2)
  // Variance
  cashVariance        Decimal                 @default(0) @db.Decimal(12, 2)
  varianceExplanation String?
  // Status
  status              DailyCashSummaryStatus  @default(DRAFT)
  submittedAt         DateTime?
  submittedById       String?
  reviewedAt          DateTime?
  reviewedById        String?
  reviewNotes         String?
  notes               String?
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt

  @@unique([shopId, summaryDate])
  @@index([businessId])
  @@index([shopId])
  @@index([summaryDate])
  @@index([status])
}

// Commission - Track staff commissions
model Commission {
  id              String            @id @default(cuid())
  businessId      String
  shopId          String
  staffMemberId   String            // ShopMember who earned commission
  staffRole       Role
  sourceType      CommissionSource  // What action generated commission
  sourceId        String            // Purchase or Payment ID
  baseAmount      Decimal           @db.Decimal(12, 2) // Amount commission calculated on
  rate            Decimal           @db.Decimal(5, 4)  // Commission rate (e.g., 0.05 for 5%)
  amount          Decimal           @db.Decimal(12, 2) // Calculated commission amount
  status          CommissionStatus  @default(PENDING)
  paidAt          DateTime?
  paidById        String?
  paymentRef      String?           // Payment reference when paid
  notes           String?
  periodStart     DateTime          @db.Date
  periodEnd       DateTime          @db.Date
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([businessId])
  @@index([shopId])
  @@index([staffMemberId])
  @@index([status])
  @@index([periodStart, periodEnd])
}

// Enums for new accountant models
enum ExpenseCategory {
  RENT
  UTILITIES
  SALARIES
  SUPPLIES
  TRANSPORT
  MARKETING
  MAINTENANCE
  INSURANCE
  TAXES
  BANK_CHARGES
  COMMUNICATION
  INVENTORY
  EQUIPMENT
  PROFESSIONAL_SERVICES
  OTHER
}

enum ExpenseStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}

enum BudgetPeriod {
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum DisputeType {
  AMOUNT_MISMATCH
  DUPLICATE_PAYMENT
  UNAUTHORIZED_PAYMENT
  MISSING_PAYMENT
  WRONG_CUSTOMER
  FRAUDULENT
  OTHER
}

enum DisputeStatus {
  OPEN
  INVESTIGATING
  RESOLVED
  CLOSED
  ESCALATED
}

enum RefundReason {
  PRODUCT_DEFECT
  WRONG_PRODUCT
  CUSTOMER_REQUEST
  OVERCHARGE
  DUPLICATE_CHARGE
  DELIVERY_FAILURE
  OTHER
}

enum RefundStatus {
  PENDING
  APPROVED
  PROCESSING
  COMPLETED
  REJECTED
}

enum NoteEntityType {
  PAYMENT
  PURCHASE
  CUSTOMER
  EXPENSE
  REFUND
  DISPUTE
}

enum DailyCashSummaryStatus {
  DRAFT
  SUBMITTED
  REVIEWED
  APPROVED
}

enum CommissionSource {
  SALE
  COLLECTION
}

enum CommissionStatus {
  PENDING
  APPROVED
  PAID
  CANCELLED
}

// ============================================================================
// BONUS SYSTEM - Business admin configurable bonus rules and records
// ============================================================================

// BonusRule - Configurable bonus rules designed by business admin
model BonusRule {
  id                String          @id @default(cuid())
  businessId        String
  name              String          // e.g. "Collection Commission", "New Customer Bonus"
  description       String?         @db.Text
  
  // Who qualifies
  targetRole        Role            // SALES_STAFF, DEBT_COLLECTOR, SHOP_ADMIN
  shopId            String?         // null = all shops, or specific shop
  
  // What triggers the bonus
  triggerType        BonusTriggerType
  
  // How it's calculated
  calculationType   BonusCalculationType // PERCENTAGE or FIXED_AMOUNT
  value             Decimal          @db.Decimal(12, 4) // % rate or fixed amount
  
  // Thresholds & caps
  minimumThreshold  Decimal?         @db.Decimal(12, 2) // Min amount/count to qualify
  maximumCap        Decimal?         @db.Decimal(12, 2) // Max bonus per period
  
  // Target-based bonuses (optional)
  targetAmount      Decimal?         @db.Decimal(12, 2) // Target to hit for bonus
  
  // Tiered bonuses (JSON array of { threshold, rate/amount })
  tiers             String?          @db.Text // JSON: [{ "min": 0, "max": 5000, "value": 3 }, { "min": 5000, "max": 10000, "value": 5 }]
  
  // Period
  period            BonusPeriod      @default(MONTHLY)
  
  // Status
  isActive          Boolean          @default(true)
  
  // Metadata
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  createdById       String?          // Business admin who created it
  
  // Relations
  business          Business         @relation("BusinessBonusRules", fields: [businessId], references: [id], onDelete: Cascade)
  shop              Shop?            @relation("ShopBonusRules", fields: [shopId], references: [id], onDelete: SetNull)
  bonusRecords      BonusRecord[]    @relation("BonusRuleRecords")
  
  @@index([businessId])
  @@index([shopId])
  @@index([targetRole])
  @@index([triggerType])
  @@index([isActive])
}

// BonusRecord - Individual earned bonus records
model BonusRecord {
  id                String          @id @default(cuid())
  businessId        String
  shopId            String
  bonusRuleId       String
  staffMemberId     String          // ShopMember who earned the bonus
  staffUserId       String          // User ID for easier lookups
  staffName         String          // Snapshot of staff name
  staffRole         Role
  
  // What triggered it
  triggerType       BonusTriggerType
  sourceId          String?         // Purchase, Payment, or Customer ID
  sourceRef         String?         // e.g. purchase number, payment ref
  
  // Calculation details
  baseAmount        Decimal         @db.Decimal(12, 2) // Amount bonus was calculated on
  rate              Decimal?        @db.Decimal(12, 4) // Rate used (if percentage)
  amount            Decimal         @db.Decimal(12, 2) // Final bonus amount
  
  // Period
  periodStart       DateTime        @db.Date
  periodEnd         DateTime        @db.Date
  
  // Status & payout
  status            BonusStatus     @default(PENDING)
  approvedAt        DateTime?
  approvedById      String?
  approvedByName    String?
  paidAt            DateTime?
  paidById          String?
  paidByName        String?
  paymentRef        String?         // Transaction reference for payout
  
  notes             String?         @db.Text
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  // Relations
  business          Business        @relation("BusinessBonusRecords", fields: [businessId], references: [id], onDelete: Cascade)
  bonusRule         BonusRule       @relation("BonusRuleRecords", fields: [bonusRuleId], references: [id], onDelete: Cascade)
  
  @@index([businessId])
  @@index([shopId])
  @@index([bonusRuleId])
  @@index([staffMemberId])
  @@index([staffUserId])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@index([triggerType])
  @@index([createdAt])
}

enum BonusTriggerType {
  COLLECTION          // Payment collected by collector
  SALE                // New sale/purchase created
  CUSTOMER_CREATED    // New customer registered
  FULL_PAYMENT        // Customer fully pays off purchase
  ON_TIME_COLLECTION  // Payment collected before due date
  RECOVERY            // Payment from overdue/defaulted account
  TARGET_HIT          // Monthly/weekly target achieved
  SHOP_PERFORMANCE    // Shop-level performance bonus
  ZERO_DEFAULT        // No defaults in period
}

enum BonusCalculationType {
  PERCENTAGE    // value is a % (e.g. 5 = 5%)
  FIXED_AMOUNT  // value is a fixed GHS amount
}

enum BonusPeriod {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
  ONE_TIME
}

enum BonusStatus {
  PENDING
  APPROVED
  PAID
  REJECTED
  CANCELLED
}

// ============================================================================
// CONTACT MESSAGES
// ============================================================================

model ContactMessage {
  id          String               @id @default(cuid())
  name        String
  email       String
  phone       String?
  subject     String
  message     String               @db.Text
  status      ContactMessageStatus @default(UNREAD)
  repliedAt   DateTime?
  repliedBy   String?              // Super admin user ID
  replyNote   String?              @db.Text
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  @@index([status])
  @@index([createdAt])
}

enum ContactMessageStatus {
  UNREAD
  READ
  REPLIED
  ARCHIVED
}

// ============================================================================
// BUSINESS REGISTRATION REQUESTS
// ============================================================================

model BusinessRegistration {
  id               String                     @id @default(cuid())
  // Applicant info
  ownerName        String
  ownerEmail       String
  ownerPhone       String
  // Business info
  businessName     String
  businessType     String?                    // e.g. "Electronics", "Furniture"
  city             String?
  address          String?
  numberOfShops    Int                        @default(1)
  numberOfStaff    Int                        @default(1)
  monthlyRevenue   String?                    // Estimated range
  howHeard         String?                    // How they heard about us
  message          String?                    @db.Text

  status           RegistrationStatus         @default(PENDING)
  reviewedAt       DateTime?
  reviewedById     String?                    // Super admin user ID
  reviewedByName   String?
  rejectionReason  String?                    @db.Text
  businessId       String?                    // Set when approved & business created

  createdAt        DateTime                   @default(now())
  updatedAt        DateTime                   @updatedAt

  @@index([status])
  @@index([createdAt])
  @@index([ownerEmail])
}

enum RegistrationStatus {
  PENDING
  APPROVED
  REJECTED
}

// ============================================================================
// SUBSCRIPTION / PLANS
// ============================================================================

model SubscriptionPlan {
  id                String         @id @default(cuid())
  name              String         @unique    // "starter", "professional", "enterprise"
  displayName       String                    // "Starter", "Professional", "Enterprise"
  price             Decimal        @default(0) @db.Decimal(10, 2)
  currency          String         @default("GHS")
  billingPeriod     BillingPeriod  @default(MONTHLY)
  // Limits
  maxShops          Int            @default(1)
  maxCustomers      Int            @default(50)
  maxStaff          Int            @default(3)
  maxSmsPerMonth    Int            @default(50)
  // Feature flags
  advancedPos       Boolean        @default(false)
  advancedAnalytics Boolean        @default(false)
  prioritySupport   Boolean        @default(false)
  customBranding    Boolean        @default(false)
  apiAccess         Boolean        @default(false)
  accountingModule  Boolean        @default(false)
  bonusSystem       Boolean        @default(false)

  isActive          Boolean        @default(true)
  sortOrder         Int            @default(0)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  subscriptions     Subscription[] @relation("PlanSubscriptions")
}

model Subscription {
  id              String             @id @default(cuid())
  businessId      String             @unique
  planId          String
  status          SubscriptionStatus @default(ACTIVE)
  // Billing
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  // Payment tracking
  lastPaymentAt      DateTime?
  lastPaymentAmount  Decimal?       @db.Decimal(10, 2)
  lastPaymentMethod  String?        // "momo", "bank", "card"
  lastPaymentRef     String?
  
  cancelledAt     DateTime?
  cancelReason    String?

  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  business        Business           @relation("BusinessSubscription", fields: [businessId], references: [id], onDelete: Cascade)
  plan            SubscriptionPlan   @relation("PlanSubscriptions", fields: [planId], references: [id])
  payments        SubscriptionPayment[] @relation("SubscriptionPayments")

  @@index([businessId])
  @@index([planId])
  @@index([status])
  @@index([currentPeriodEnd])
}

model SubscriptionPayment {
  id              String        @id @default(cuid())
  subscriptionId  String
  amount          Decimal       @db.Decimal(10, 2)
  currency        String        @default("GHS")
  paymentMethod   String        // "momo", "bank_transfer", "card"
  paymentRef      String?       // Transaction reference
  momoNumber      String?       // For mobile money
  momoProvider    String?       // "mtn", "vodafone", "airteltigo"
  bankName        String?       // For bank transfers
  status          SubPaymentStatus @default(PENDING)
  
  paidAt          DateTime?
  confirmedAt     DateTime?
  confirmedById   String?       // Super admin who confirmed
  failureReason   String?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  subscription    Subscription  @relation("SubscriptionPayments", fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([status])
  @@index([createdAt])
}

enum BillingPeriod {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
  SUSPENDED
  TRIAL
}

enum SubPaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// ============================================================================
// SITE CONTENT (Admin-Editable Landing Page Content)
// ============================================================================

model SiteContent {
  id        String   @id @default(cuid())
  key       String   @unique  // e.g. "hero_title", "hero_subtitle", "phone", "testimonials"
  value     String   @db.Text // JSON or plain text
  type      String   @default("text") // "text", "json", "html", "image"
  label     String?  // Human-readable label for admin UI
  group     String   @default("general") // "general", "hero", "social", "contact", "testimonials"
  updatedBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([group])
}

// ============================================================================
// ANNOUNCEMENTS & BROADCASTS
// ============================================================================

model Announcement {
  id              String             @id @default(cuid())
  title           String
  content         String             @db.Text
  type            AnnouncementType   @default(IN_APP)
  targetAudience  TargetAudience     @default(ALL)
  targetValue     String?            // Plan ID or Role name when targeting specific
  priority        AnnouncementPriority @default(NORMAL)
  isActive        Boolean            @default(true)
  scheduledAt     DateTime?
  sentAt          DateTime?
  sentById        String
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([isActive])
  @@index([createdAt])
  @@index([targetAudience])
}

enum AnnouncementType {
  IN_APP
  EMAIL
  BOTH
}

enum TargetAudience {
  ALL
  BUSINESS_ADMINS
  SHOP_ADMINS
  COLLECTORS
  CUSTOMERS
  PLAN
}

enum AnnouncementPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// ============================================================================
// EMAIL TEMPLATES
// ============================================================================

model EmailTemplate {
  id          String   @id @default(cuid())
  name        String   @unique
  subject     String
  htmlContent String   @db.Text
  variables   String?  @db.Text // JSON array of variable names e.g. ["name", "amount"]
  category    String   @default("general") // welcome, rejection, reminder, reset, notification
  isActive    Boolean  @default(true)
  updatedBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([isActive])
}

// ============================================================================
// SUPPORT TICKETS
// ============================================================================

model SupportTicket {
  id            String         @id @default(cuid())
  ticketNumber  String         @unique
  subject       String
  description   String         @db.Text
  priority      TicketPriority @default(MEDIUM)
  status        TicketStatus   @default(OPEN)
  category      String         @default("general") // billing, technical, account, general
  contactMessageId String?     // Linked from a contact message
  businessId    String?        // Related business
  createdById   String?        // User who created it (or null for anonymous)
  assignedToId  String?        // Admin assigned to handle
  resolvedAt    DateTime?
  closedAt      DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  comments      TicketComment[]

  @@index([status])
  @@index([priority])
  @@index([createdById])
  @@index([assignedToId])
  @@index([createdAt])
}

model TicketComment {
  id         String        @id @default(cuid())
  ticketId   String
  authorId   String
  content    String        @db.Text
  isInternal Boolean       @default(false) // Internal notes not visible to user
  createdAt  DateTime      @default(now())
  ticket     SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([authorId])
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING
  RESOLVED
  CLOSED
}

// ============================================================================
// COUPONS & PROMO CODES
// ============================================================================

model Coupon {
  id            String       @id @default(cuid())
  code          String       @unique
  description   String?
  discountType  DiscountType
  discountValue Decimal      @db.Decimal(10, 2) // Percentage or fixed amount
  appliesTo     String?      // Subscription plan ID, null = all plans
  minAmount     Decimal?     @db.Decimal(10, 2)
  maxDiscount   Decimal?     @db.Decimal(10, 2) // Cap for percentage discounts
  validFrom     DateTime
  validUntil    DateTime
  maxUses       Int          @default(0) // 0 = unlimited
  usedCount     Int          @default(0)
  isActive      Boolean      @default(true)
  createdById   String
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([code])
  @@index([isActive])
  @@index([validFrom, validUntil])
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

// ============================================================================
// SUBSCRIPTION INVOICES
// ============================================================================

model SubscriptionInvoice {
  id              String        @id @default(cuid())
  invoiceNumber   String        @unique
  subscriptionId  String
  businessId      String
  businessName    String
  planName        String
  amount          Decimal       @db.Decimal(10, 2)
  currency        String        @default("GHS")
  tax             Decimal       @default(0) @db.Decimal(10, 2)
  totalAmount     Decimal       @db.Decimal(10, 2)
  status          InvoiceStatus @default(DRAFT)
  dueDate         DateTime
  paidAt          DateTime?
  notes           String?       @db.Text
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([subscriptionId])
  @@index([businessId])
  @@index([status])
  @@index([dueDate])
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
  VOID
}

// ============================================================================
// LOGIN ACTIVITY LOG
// ============================================================================

model LoginActivity {
  id            String   @id @default(cuid())
  userId        String?
  email         String
  userName      String?
  role          String?
  ipAddress     String?
  userAgent     String?  @db.Text
  success       Boolean
  failureReason String?
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([email])
  @@index([success])
  @@index([createdAt])
}

// ============================================================================
// ADMIN PERMISSIONS (Sub-Admin / Role-Based)
// ============================================================================

model AdminPermission {
  id          String   @id @default(cuid())
  userId      String   @unique
  userName    String?
  userEmail   String?
  permissions String   @db.Text // JSON object with granular permission flags
  grantedBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

// ============================================================================
// SYSTEM SETTINGS
// ============================================================================

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   @db.Text
  type      String   @default("string") // string, number, boolean, json
  label     String?
  group     String   @default("general") // general, security, billing, notifications, maintenance
  updatedBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([group])
}
